---
- name: Configure home lab
  hosts: all
  gather_facts: true
  gather_subset:
    - '!all'
    - min
    - network

  vars:
    # This group will be used to grant read access to media files between different applications
    media_shared_group: media
    # The directory is used to save finished media that can be served
    media_data_dir: /external/media

  tasks:
    - name: Gather data and set facts
      ansible.builtin.set_fact:
        internal_ip_address: "{{ ansible_facts[internal_interface].ipv4.address }}"
      tags:
        - always

    - name: Fetch hostvars
      ansible.builtin.set_fact:
        all_groups_hostvars: >-
          {{
            groups['all']
            | map('extract', hostvars)
            | list
          }}
      tags:
        - always
      run_once: true

    - name: Gather network roles and set dynamic facts (run_once)
      ansible.builtin.set_fact:
        dhcp_primary: "{{ primary_host_obj.inventory_hostname }}"
        dhcp_failover: "{{ secondary_host_obj.inventory_hostname }}"
        podman_dns: "{{ adguard_host_objs | map(attribute='inventory_hostname') | list }}"
        validate_health_before_update: "{{ other_routers if network_is_router is defined and network_is_router else [] }}"

      vars:
        primary_host_obj: >-
          {{
            all_groups_hostvars
            | selectattr('network_dhcp_role', 'defined')
            | selectattr('network_dhcp_role', 'equalto', 'primary')
            | first
          }}

        secondary_host_obj: >-
          {{
            all_groups_hostvars
            | selectattr('network_dhcp_role', 'defined')
            | selectattr('network_dhcp_role', 'equalto', 'secondary')
            | first
          }}

        adguard_host_objs: >-
          {{
            all_groups_hostvars
            | selectattr('deploy_adguard', 'defined')
            | selectattr('deploy_adguard', 'equalto', true)
            | list
          }}

        other_routers: >-
          {{
            all_groups_hostvars
            | selectattr('network_is_router', 'defined')
            | selectattr('network_is_router', 'equalto', true)
            | rejectattr('inventory_hostname', 'equalto', inventory_hostname)
            | map(attribute='inventory_hostname')
            | list
          }}

      run_once: true
      tags:
        - always

    - name: Setup media group and dirs
      when: deploy_mediastack
      block:
        - name: Ensure group exists with name {{ media_shared_group }}
          ansible.builtin.group:
            name: "{{ media_shared_group }}"
            state: present
          register: media_group_result

        - name: Set media_gid
          ansible.builtin.set_fact:
            media_gid: "{{ media_group_result.gid }}"

        - name: Create directory {{ media_data_dir }}
          ansible.builtin.file:
            path: "{{ media_data_dir }}"
            state: directory
            mode: "0770"
            group: "{{ media_shared_group }}"

    # Containers must be run before the network role
    #Â due to a dependency on Podman. A temporary internet
    # connection is expected to be available during the first setup.
    - ansible.builtin.import_role:
        name: homelab.system.containers
      become: true
      vars:
        containers_storage_dir: /app/containers
      tags:
        - first-setup
        - containers

    - ansible.builtin.import_role:
        name: homelab.system.network
      become: true
      tags:
        - first-setup
        - system-network

    - ansible.builtin.import_role:
        name: homelab.system.base
      become: true
      vars:
        base_ohmyzsh_install: true
        base_ohmyzsh_users:
          - root
          - gbaratta
      tags:
        - first-setup
        - system-base

    - ansible.builtin.import_role:
        name: homelab.system.auto_remediation
      become: true
      tags: auto-remediation

    - when: deploy_logging
      ansible.builtin.import_role:
        name: homelab.system.logging
      become: true
      vars:
        logging_enable_aws_cloudwatch: true
      tags: system-logging

    - ansible.builtin.import_role:
        name: homelab.system.ingress
      become: true
      tags: ingress

    - when: deploy_idp
      name: Identity provider
      block:
        - ansible.builtin.import_role:
            name: homelab.system.idp
          become: true
          tags: idp

        - name: Set fact from idp terraform output
          ansible.builtin.set_fact:
            vpn_netbird_idp_client_id: "{{ idp_zitadel_terraform_output.outputs.netbird_client_id.value }}"
            vpn_netbird_idp_client_secret: "{{ idp_zitadel_terraform_output.outputs.netbird_client_secret.value }}"
            coder_idp_client_id: "{{ idp_zitadel_terraform_output.outputs.coder_client_id.value }}"
            coder_idp_client_secret: "{{ idp_zitadel_terraform_output.outputs.coder_client_secret.value }}"
            remote_control_oauth2_client_id: "{{ idp_zitadel_terraform_output.outputs.olivetin_client_id.value }}"
            remote_control_oauth2_client_secret: "{{ idp_zitadel_terraform_output.outputs.olivetin_client_secret.value }}"
          tags: idp

        # Remote control depends on the OAuth available only with the IDP provider
        - ansible.builtin.import_role:
            name: homelab.system.remote_control
          become: true
          tags: remote-control

    - when: deploy_netbird
      ansible.builtin.import_role:
        name: homelab.system.vpn
      become: true
      tags: vpn

    - ansible.builtin.import_role:
        name: homelab.system.latency_monitor
      become: true
      tags: monitoring

    - name: Deploy AdGuard Home
      when: deploy_adguard
      ansible.builtin.import_role:
        name: homelab.apps.adguard
      become: true
      tags:
        - first-setup
        - adguard

    - when: deploy_prometheus
      ansible.builtin.import_role:
        name: homelab.apps.prometheus
      become: true
      tags: prometheus

    - ansible.builtin.import_role:
        name: prometheus.prometheus.node_exporter
      become: true
      vars:
        node_exporter_web_listen_address: "{{ internal_ip_address }}:9100"
      tags: prometheus

    - when: deploy_grafana
      ansible.builtin.import_role:
        name: homelab.apps.grafana
      become: true
      tags: grafana

    - when: deploy_mqtt
      ansible.builtin.import_role:
        name: homelab.apps.mqtt_broker
      become: true
      tags: mqtt-broker

    - when: deploy_home_assistant
      ansible.builtin.import_role:
        name: homelab.apps.home_assistant
      become: true
      tags: home-assistant

    - when: deploy_coder
      ansible.builtin.import_role:
        name: homelab.apps.coder
      become: true
      tags: coder

    - when: deploy_mediastack
      ansible.builtin.import_role:
        name: homelab.apps.media_server
      vars:
        media_server_media_dir: "{{ media_data_dir }}"
      become: true
      tags: media-server

    - when: deploy_mediastack
      ansible.builtin.import_role:
        name: homelab.apps.p2p
      vars:
        # The directory is used to stage downloaded and incomplete files
        p2p_downloads_dir: /external/downloads
        p2p_sonarr_media_dir: "{{ media_data_dir }}/tv"
        p2p_radarr_media_dir: "{{ media_data_dir }}/movies"
      become: true
      tags: p2p
