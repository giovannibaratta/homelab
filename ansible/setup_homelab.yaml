---
- name: Configure home lab
  hosts: all

  vars:
    # This group will be used to grant read access to media files between different applications
    media_shared_group: "media"
    # The directory is used to save finished media that can be served
    media_data_dir: "/external/media"

  pre_tasks:
    - name: Ensure group exists with name {{ media_shared_group }}
      ansible.builtin.group:
        name: "{{ media_shared_group }}"
        state: present
      register: media_group_result

    - name: Set media_gid
      ansible.builtin.set_fact:
        media_gid: "{{ media_group_result.gid }}"

    - name: Create directory {{ media_data_dir }}
      ansible.builtin.file:
        path: "{{ media_data_dir }}"
        state: directory
        mode: "0770"
        group: "{{ media_shared_group }}"

  roles:
    - role: homelab.system.network
      become: true
      tags: "system-network"

    - role: homelab.system.base
      become: true
      base_ohmyzsh_install: true
      base_ohmyzsh_users:
        - root
        - gbaratta
      tags: "system-base"

    - role: homelab.system.ingress
      become: true
      tags: "ingress"

    - role: homelab.system.containers
      become: true
      system_containers_storage_dir: "/app/containers"
      tags: "containers"

    - role: homelab.system.latency_monitor
      become: true
      tags: "monitoring"

    - role: homelab.apps.adguard
      become: true
      tags: "adguard"

    - role: homelab.apps.prometheus
      become: true
      tags: "prometheus"

    - role: prometheus.prometheus.node_exporter
      become: true
      node_exporter_web_listen_address: "172.16.255.254:9100"
      tags: "prometheus"

    - role: homelab.apps.grafana
      become: true
      tags: "grafana"

    - role: homelab.apps.coder
      become: true
      tags: "coder"

    - role: homelab.apps.media_server
      plex_media_dir: "{{ media_data_dir }}"
      become: true
      tags: "media-server"

    - role: homelab.apps.p2p
      # The directory is used to stage downloaded and incomplete files
      p2p_downloads_dir: "/external/torrent/downloads"
      p2p_sonarr_media_dir: "{{ media_data_dir }}/tv"
      become: true
      tags: "p2p"
